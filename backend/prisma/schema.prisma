// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  username       String    @unique
  passwordHash   String
  firstName      String?
  lastName       String?
  phone          String?
  city           String?
  country        String?
  additionalInfo String?  @db.Text
  profilePhoto   String?   @db.Text
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  trips            Trip[]
  savedDestinations SavedDestination[]

  @@map("users")
}

model Trip {
  id          String      @id @default(cuid())
  userId      String
  name        String
  description String?     @db.Text
  coverPhoto  String?     @db.Text
  startDate   DateTime
  endDate     DateTime
  budget      Float       @default(0)
  status      TripStatus  @default(UPCOMING)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sections     TripSection[]
  publicShare  PublicShare?

  @@map("trips")
}

enum TripStatus {
  ONGOING
  UPCOMING
  COMPLETED
}

model TripSection {
  id                String           @id @default(cuid())
  tripId            String
  title             String?
  notes             String?          @db.Text
  startDate         DateTime
  endDate           DateTime
  budget            Float            @default(0)
  sectionType       SectionType      @default(BUFFER)
  order             Int              @default(0)
  hasOverlapWarning Boolean          @default(false)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  trip       Trip             @relation(fields: [tripId], references: [id], onDelete: Cascade)
  activities SectionActivity[]

  @@map("trip_sections")
}

enum SectionType {
  TRAVEL
  STAY
  EXPERIENCE
  BUFFER
}

model City {
  id             String     @id @default(cuid())
  name           String
  country        String
  latitude       Float?
  longitude      Float?
  popularityScore Int       @default(0)
  createdAt      DateTime   @default(now())

  activities         Activity[]
  savedDestinations  SavedDestination[]

  @@unique([name, country])
  @@map("cities")
}

model Activity {
  id          String    @id @default(cuid())
  name        String
  type        ActivityType
  description String?   @db.Text
  cost        Float     @default(0)
  duration    Int       @default(60) // in minutes
  cityId      String
  createdAt   DateTime  @default(now())

  city            City             @relation(fields: [cityId], references: [id], onDelete: Cascade)
  sectionActivities SectionActivity[]

  @@map("activities")
}

enum ActivityType {
  TRAVEL
  STAY
  EXPERIENCE
  BUFFER
}

model SectionActivity {
  id            String    @id @default(cuid())
  sectionId     String
  activityId    String
  scheduledDate DateTime
  scheduledTime String?   // e.g., "14:30"
  expense       Float     @default(0)
  order         Int       @default(0)
  createdAt     DateTime  @default(now())

  section  TripSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  activity Activity    @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@map("section_activities")
}

model PublicShare {
  id        String   @id @default(cuid())
  tripId    String   @unique
  slug      String   @unique
  isPublic  Boolean  @default(true)
  createdAt DateTime @default(now())

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@map("public_shares")
}

model SavedDestination {
  id        String   @id @default(cuid())
  userId    String
  cityId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  city City @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@unique([userId, cityId])
  @@map("saved_destinations")
}

